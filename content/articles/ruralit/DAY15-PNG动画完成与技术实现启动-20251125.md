# Ruralilt 项目日报 - DAY15

**日期：** 2025年11月25日
**项目：** Ruralilt - MediaPipe驱动的乡村儿童舞蹈学习与社交平台
**目标：** PNG序列帧动画完成 + 技术实现启动

---

## 今日工作内容

### 1. PNG序列帧动画完成 ✅

#### 1.1 考拉（Kite）待机动画

**导出规格：**
- 格式：PNG序列帧
- 尺寸：400×400px @2x
- 帧数：24帧
- 帧率：12fps
- 循环时长：2秒

**动画内容：**
- 眨眼（第8-12帧）
- 耳朵微动（第1-24帧循环）
- 身体呼吸起伏（全程）

**文件结构：**
```
public/animations/koala_idle/
├── frame_001.png
├── frame_002.png
├── ...
└── frame_024.png
```

#### 1.2 小羊（Rainbow）庆祝动画

**导出规格：**
- 帧数：18帧
- 帧率：12fps
- 循环时长：1.5秒

**动画内容：**
- 跳跃（上下位移）
- 星星闪烁环绕
- 表情变化（闭眼微笑）

#### 1.3 粒子特效序列

**庆祝粒子：**
- 帧数：30帧
- 用于：评分≥90分触发
- 彩色纸屑 + 星星爆发效果

---

### 2. 技术实现启动 ✅

#### 2.1 项目架构确认

```
技术栈：
├── 前端：React + TypeScript + Vite
├── 移动端：Capacitor（Android/iOS）
├── 姿态追踪：MediaPipe Pose
├── 动画：PNG序列帧 / CSS Animation
└── 视频处理：HTML5 Video + Canvas
```

#### 2.2 PNG序列帧播放器封装

```typescript
interface FrameAnimationProps {
  frames: string[];        // 帧图片路径数组
  fps: number;             // 帧率
  loop: boolean;           // 是否循环
  autoplay: boolean;       // 自动播放
  onComplete?: () => void; // 播放完成回调
}

const FrameAnimation: React.FC<FrameAnimationProps> = ({
  frames,
  fps = 12,
  loop = true,
  autoplay = true,
  onComplete
}) => {
  const [currentFrame, setCurrentFrame] = useState(0);
  
  useEffect(() => {
    if (!autoplay) return;
    
    const interval = setInterval(() => {
      setCurrentFrame(prev => {
        if (prev >= frames.length - 1) {
          if (loop) return 0;
          onComplete?.();
          return prev;
        }
        return prev + 1;
      });
    }, 1000 / fps);
    
    return () => clearInterval(interval);
  }, [frames, fps, loop, autoplay]);
  
  return <img src={frames[currentFrame]} alt="animation" />;
};
```

#### 2.3 图片预加载优化

```typescript
// 预加载所有帧，避免播放时闪烁
function preloadFrames(framePaths: string[]): Promise<void> {
  return Promise.all(
    framePaths.map(src => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = reject;
        img.src = src;
      });
    })
  ).then(() => {});
}

// 使用
useEffect(() => {
  preloadFrames(koalaIdleFrames).then(() => {
    setIsLoaded(true);
  });
}, []);
```

---

### 3. MediaPipe集成准备 ✅

#### 3.1 依赖安装

```bash
npm install @mediapipe/pose @mediapipe/camera_utils @mediapipe/drawing_utils
```

#### 3.2 基础配置

```typescript
const pose = new Pose({
  locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
  }
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  enableSegmentation: false,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});
```

#### 3.3 摄像头权限处理

```typescript
async function requestCameraPermission(): Promise<boolean> {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' } 
    });
    stream.getTracks().forEach(track => track.stop());
    return true;
  } catch (error) {
    console.error('Camera permission denied:', error);
    return false;
  }
}
```

---

### 4. 文件结构更新

```
src/
├── components/
│   ├── FrameAnimation.tsx     ✨ 新增
│   ├── PoseDetection.tsx      ✨ 新增（骨架）
│   └── ...
├── utils/
│   └── preloadImages.ts       ✨ 新增
public/
├── animations/
│   ├── koala_idle/            ✨ 新增
│   ├── sheep_celebrate/       ✨ 新增
│   └── particles/             ✨ 新增
```

---

## 今日关键洞察

### 1. PNG序列帧 vs Lottie
- PNG序列帧：文件大但兼容性100%，适合复杂插画
- Lottie：文件小但需要AE制作，适合简单图形动画
- 本项目选择PNG序列帧，因为IP插画细节丰富

### 2. 预加载是关键
- 不预加载会导致首次播放卡顿/闪烁
- 24帧@2x约2MB，需要loading状态

### 3. 帧率选择
- 12fps足够流畅，且文件量可控
- 24fps更丝滑但文件翻倍
- 舞蹈场景12fps够用

---

## 待解决问题

1. **动画文件体积优化**
   - 当前：24帧约2MB
   - 考虑：WebP格式压缩

2. **低端设备性能**
   - 序列帧+MediaPipe同时运行
   - 需要真机测试

---

## 明日计划

### DAY16 目标：虚拟老师MR叠加 + ComfyUI卡通视频

1. **虚拟老师视频叠加**
   - 画中画模式实现
   - 绿幕去除（Chroma Key）

2. **ComfyUI工作流**
   - 真人舞蹈视频 → 卡通风格转化
   - 批量处理流程

---

## 今日成果总结

✅ 完成考拉、小羊PNG序列帧动画导出
✅ 封装FrameAnimation组件，支持循环/回调
✅ 实现图片预加载，解决首帧闪烁问题
✅ MediaPipe依赖安装，基础配置完成

**设计→技术的桥梁搭好了，明天开始核心功能开发！**

---

**项目进度：** █████████░ 48%（动画完成，技术启动）
