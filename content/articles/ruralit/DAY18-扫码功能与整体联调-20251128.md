# Ruralilt é¡¹ç›®æ—¥æŠ¥ - DAY18

**æ—¥æœŸï¼š** 2025å¹´11æœˆ28æ—¥
**é¡¹ç›®ï¼š** Ruralilt - MediaPipeé©±åŠ¨çš„ä¹¡æ‘å„¿ç«¥èˆè¹ˆå­¦ä¹ ä¸ç¤¾äº¤å¹³å°
**ç›®æ ‡ï¼š** æ‰«ç åŠŸèƒ½å®ç° + æ•´ä½“è”è°ƒ

---

## ä»Šæ—¥å·¥ä½œå†…å®¹

### 1. æ‰«ç åŠŸèƒ½å®ç° âœ…

#### 1.1 æŠ€æœ¯æ–¹æ¡ˆé€‰æ‹©

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‰æ‹© |
|------|------|------|------|
| ML Kit Barcode | åŸç”Ÿæ€§èƒ½å¥½ | éœ€è¦åŸç”Ÿä»£ç  | âŒ |
| ZXing.js | çº¯JSï¼Œè·¨å¹³å° | æ€§èƒ½ä¸€èˆ¬ | âŒ |
| html5-qrcode | è½»é‡ï¼Œæ˜“é›†æˆ | åŠŸèƒ½å¤Ÿç”¨ | âœ… |

**æœ€ç»ˆé€‰æ‹©ï¼š** `html5-qrcode`ï¼Œè½»é‡ä¸”æ»¡è¶³éœ€æ±‚

#### 1.2 ä¾èµ–å®‰è£…

```bash
npm install html5-qrcode
```

#### 1.3 æ‰«ç ç»„ä»¶å®ç°

```typescript
import { Html5Qrcode } from 'html5-qrcode';

interface QRScannerProps {
  onScanSuccess: (cardId: string) => void;
  onScanError?: (error: string) => void;
  onClose: () => void;
}

const QRScanner: React.FC<QRScannerProps> = ({
  onScanSuccess,
  onScanError,
  onClose
}) => {
  const scannerRef = useRef<Html5Qrcode | null>(null);
  
  useEffect(() => {
    const scanner = new Html5Qrcode('qr-reader');
    scannerRef.current = scanner;
    
    scanner.start(
      { facingMode: 'environment' },  // åç½®æ‘„åƒå¤´
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      (decodedText) => {
        // è§£æå¡ç‰‡ID
        const cardId = parseCardId(decodedText);
        if (cardId) {
          scanner.stop();
          onScanSuccess(cardId);
        }
      },
      (errorMessage) => {
        // æ‰«æä¸­çš„é”™è¯¯ï¼ˆæ­£å¸¸ï¼Œä¸éœ€è¦å¤„ç†ï¼‰
      }
    );
    
    return () => {
      scanner.stop().catch(() => {});
    };
  }, []);
  
  return (
    <div className="qr-scanner-overlay">
      <div className="scanner-header">
        <span>Point camera at card's QR code</span>
        <button onClick={onClose}>âœ•</button>
      </div>
      <div id="qr-reader" />
      <div className="scan-frame" />
    </div>
  );
};
```

#### 1.4 äºŒç»´ç æ ¼å¼å®šä¹‰

**å¡ç‰‡IDç¼–ç è§„åˆ™ï¼š**
```
æ ¼å¼ï¼šRURALILT_CARD_{cardNumber}_{uniqueId}
ç¤ºä¾‹ï¼šRURALILT_CARD_001_A7B3C9
```

**è§£æå‡½æ•°ï¼š**
```typescript
function parseCardId(qrContent: string): string | null {
  const regex = /^RURALILT_CARD_(\d{3})_([A-Z0-9]{6})$/;
  const match = qrContent.match(regex);
  
  if (match) {
    return match[1]; // è¿”å›å¡ç‰‡ç¼–å· "001"
  }
  return null;
}
```

#### 1.5 æ‰«ç UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Point camera at card's QR code  âœ• â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚             â”‚             â”‚
â”‚         â”‚   æ‰«ææ¡†     â”‚  â† é»„è‰²è¾¹æ¡† â”‚
â”‚         â”‚             â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                     â”‚
â”‚         ï½ï½ï½ï½ï½ï½ï½  â† æ³¢å½¢åŠ¨ç”»    â”‚
â”‚                                     â”‚
â”‚      [å®ä½“å¡ç‰‡ç¤ºæ„å›¾]               â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. æ‰«ç è§£é”æµç¨‹ âœ…

#### 2.1 å®Œæ•´æµç¨‹

```
Meé¡µå³ä¸Šè§’ç›¸æœºå›¾æ ‡
        â†“ ç‚¹å‡»
    æ‰«ç å¼¹çª—æ‰“å¼€
        â†“ å¯¹å‡†å¡ç‰‡
    è¯†åˆ«äºŒç»´ç 
        â†“ è§£ææˆåŠŸ
    å…³é—­æ‰«ç å¼¹çª—
        â†“
    æ’­æ”¾è§£é”åŠ¨ç”»
        â†“
    Rainbow Readyå¼¹çª—
        â†“ ç‚¹å‡»Collect
    å¡ç‰‡åŠ å…¥æ”¶è—
        â†“
    è·³è½¬Collectioné¡µ
```

#### 2.2 çŠ¶æ€ç®¡ç†

```typescript
// å…¨å±€å¡ç‰‡çŠ¶æ€
interface CardState {
  unlockedCards: string[];      // å·²è§£é”å¡ç‰‡ID
  pendingUnlock: string | null; // å¾…è§£é”å¡ç‰‡ï¼ˆè§¦å‘åŠ¨ç”»ï¼‰
}

// Zustand store
const useCardStore = create<CardState>((set) => ({
  unlockedCards: [],
  pendingUnlock: null,
  
  unlockCard: (cardId: string) => {
    set((state) => ({
      unlockedCards: [...state.unlockedCards, cardId],
      pendingUnlock: cardId
    }));
  },
  
  clearPending: () => {
    set({ pendingUnlock: null });
  }
}));
```

#### 2.3 è§£é”åŠ¨ç”»è§¦å‘

```typescript
// App.tsx
const { pendingUnlock, clearPending } = useCardStore();

useEffect(() => {
  if (pendingUnlock) {
    // æ˜¾ç¤ºRainbow Readyå¼¹çª—
    setShowUnlockModal(true);
  }
}, [pendingUnlock]);

// å¼¹çª—å…³é—­åæ¸…é™¤pendingçŠ¶æ€
const handleModalClose = () => {
  setShowUnlockModal(false);
  clearPending();
};
```

---

### 3. æ•´ä½“è”è°ƒ âœ…

#### 3.1 å­¦ä¹ æµç¨‹æµ‹è¯•

**æµ‹è¯•è·¯å¾„ï¼š**
```
é¦–é¡µ â†’ è¯¾ç¨‹å¡ç‰‡ â†’ è¯¾ç¨‹è¯¦æƒ…é¡µ â†’ å¼€å§‹ç»ƒä¹  
â†’ MRç»ƒä¹ ç•Œé¢ â†’ å®Œæˆç»ƒä¹  â†’ ç»“æœé¡µ â†’ Finish
â†’ è¿”å›é¦–é¡µ
```

**æµ‹è¯•ç»“æœï¼š**
| ç¯èŠ‚ | çŠ¶æ€ | é—®é¢˜ |
|------|------|------|
| é¦–é¡µâ†’è¯¾ç¨‹è¯¦æƒ… | âœ… | - |
| è¯¾ç¨‹è¯¦æƒ…â†’ç»ƒä¹  | âœ… | - |
| MediaPipeè¿½è¸ª | âœ… | ä½ç«¯æœºç•¥å¡ |
| è™šæ‹Ÿè€å¸ˆå åŠ  | âœ… | - |
| å®æ—¶è¯„åˆ† | âœ… | - |
| çº é”™æç¤º | âœ… | - |
| ç»ƒä¹ â†’ç»“æœé¡µ | âœ… | - |
| ç»“æœé¡µâ†’é¦–é¡µ | âœ… | - |

#### 3.2 æ‰«ç è§£é”æµç¨‹æµ‹è¯•

**æµ‹è¯•è·¯å¾„ï¼š**
```
Meé¡µ â†’ ç›¸æœºå›¾æ ‡ â†’ æ‰«ç å¼¹çª— â†’ æ‰«æå¡ç‰‡ 
â†’ è§£é”åŠ¨ç”» â†’ Rainbow Readyå¼¹çª— â†’ Collect
â†’ Collectioné¡µ
```

**æµ‹è¯•ç»“æœï¼š**
| ç¯èŠ‚ | çŠ¶æ€ | é—®é¢˜ |
|------|------|------|
| æ‰“å¼€æ‰«ç  | âœ… | - |
| æ‘„åƒå¤´æƒé™ | âœ… | é¦–æ¬¡éœ€æˆæƒ |
| äºŒç»´ç è¯†åˆ« | âœ… | å…‰çº¿æš—æ—¶è¾ƒæ…¢ |
| è§£é”åŠ¨ç”» | âœ… | - |
| å¼¹çª—æ˜¾ç¤º | âœ… | - |
| å¡ç‰‡å…¥åº“ | âœ… | - |

#### 3.3 å‘ç°çš„Bug

**Bug #1ï¼šæ‰«ç åæ‘„åƒå¤´æœªé‡Šæ”¾**
```typescript
// ä¿®å¤ï¼šç¡®ä¿stop()è¢«è°ƒç”¨
const handleScanSuccess = async (cardId: string) => {
  await scannerRef.current?.stop();  // å…ˆåœæ­¢
  onScanSuccess(cardId);
};
```

**Bug #2ï¼šé‡å¤æ‰«åŒä¸€å¼ å¡**
```typescript
// ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²è§£é”
const handleScanSuccess = (cardId: string) => {
  if (unlockedCards.includes(cardId)) {
    showToast('This card is already in your collection!');
    return;
  }
  unlockCard(cardId);
};
```

**Bug #3ï¼šç»ƒä¹ é¡µè¿”å›æ—¶MediaPipeæœªé”€æ¯**
```typescript
// ä¿®å¤ï¼šuseEffect cleanup
useEffect(() => {
  return () => {
    pose.close();
    camera.stop();
  };
}, []);
```

#### 3.4 æ€§èƒ½æµ‹è¯•

| åœºæ™¯ | å¸§ç‡ | å†…å­˜ | çŠ¶æ€ |
|------|------|------|------|
| é¦–é¡µæµè§ˆ | 60fps | 80MB | âœ… |
| ç»ƒä¹ ç•Œé¢ | 28fps | 150MB | âœ… |
| æ‰«ç ç•Œé¢ | 30fps | 90MB | âœ… |
| é•¿æ—¶é—´ç»ƒä¹ (5min) | 26fps | 160MB | âœ… |

---

### 4. è¾¹ç•Œæƒ…å†µå¤„ç† âœ…

#### 4.1 æ‘„åƒå¤´æƒé™è¢«æ‹’

```typescript
const handleCameraError = (error: Error) => {
  if (error.name === 'NotAllowedError') {
    showModal({
      title: 'Camera Access Needed',
      message: 'Please allow camera access to scan cards',
      actions: [
        { text: 'Open Settings', onClick: openAppSettings },
        { text: 'Cancel', onClick: closeModal }
      ]
    });
  }
};
```

#### 4.2 æ— æ•ˆäºŒç»´ç 

```typescript
// è¿ç»­æ‰«æå¤±è´¥5ç§’åæç¤º
const [scanAttempts, setScanAttempts] = useState(0);

useEffect(() => {
  if (scanAttempts > 50) { // 10fps * 5ç§’
    showToast('Cannot recognize this code. Try a Ruralilt card!');
    setScanAttempts(0);
  }
}, [scanAttempts]);
```

#### 4.3 ç½‘ç»œæ–­å¼€

```typescript
// ç¦»çº¿æ¨¡å¼ï¼šæœ¬åœ°å­˜å‚¨å·²è§£é”å¡ç‰‡
const saveToLocal = (cards: string[]) => {
  localStorage.setItem('unlocked_cards', JSON.stringify(cards));
};

const loadFromLocal = (): string[] => {
  const data = localStorage.getItem('unlocked_cards');
  return data ? JSON.parse(data) : [];
};
```

---

## ä»Šæ—¥å…³é”®æ´å¯Ÿ

### 1. html5-qrcodeå¤Ÿç”¨
- ä¸éœ€è¦åŸç”ŸML Kit
- çº¯Webæ–¹æ¡ˆï¼Œè·¨å¹³å°ä¸€è‡´
- è¯†åˆ«é€Ÿåº¦å¯æ¥å—ï¼ˆ<1ç§’ï¼‰

### 2. çŠ¶æ€ç®¡ç†å¾ˆé‡è¦
- æ‰«ç â†’è§£é”â†’åŠ¨ç”»â†’å…¥åº“ï¼Œæ¶‰åŠå¤šä¸ªç»„ä»¶
- Zustandè½»é‡ä¸”å¤Ÿç”¨
- pendingUnlockæ¨¡å¼è§£å†³åŠ¨ç”»è§¦å‘é—®é¢˜

### 3. èµ„æºé‡Šæ”¾æ˜¯å¤§å‘
- æ‘„åƒå¤´ã€MediaPipeéƒ½éœ€è¦æ‰‹åŠ¨é‡Šæ”¾
- useEffect cleanupå¿…é¡»å†™
- å¦åˆ™å†…å­˜æ³„æ¼+æ‘„åƒå¤´å ç”¨

---

## å¾…ä¼˜åŒ–é¡¹

1. **æ‰«ç é€Ÿåº¦ä¼˜åŒ–**
   - å½“å‰ï¼šå…‰çº¿å¥½<1ç§’ï¼Œå…‰çº¿æš—2-3ç§’
   - å¯åŠ ï¼šæ‰‹ç”µç­’æŒ‰é’®

2. **ç¦»çº¿åŒæ­¥**
   - å½“å‰ï¼šçº¯æœ¬åœ°å­˜å‚¨
   - åç»­ï¼šè”ç½‘æ—¶åŒæ­¥åˆ°äº‘ç«¯

3. **é‡å¤å¡ç‰‡å¤„ç†**
   - å½“å‰ï¼šæç¤ºå·²æ‹¥æœ‰
   - å¯åŠ ï¼šæ˜¾ç¤ºè·å¾—æ—¶é—´/æ¥æº

---

## é¡¹ç›®æ•´ä½“è¿›åº¦

```
âœ… DAY01-03ï¼šäº§å“é€»è¾‘æ¢³ç†
âœ… DAY04-05ï¼šIPè®¾è®¡ + æŠ€æœ¯è°ƒç ”
âœ… DAY06-07ï¼šé™æ€é«˜ä¿çœŸå®Œæˆ
âœ… DAY09-13ï¼šè®¾è®¡é˜¶æ®µï¼ˆåŠ¨ç”»åˆ¶ä½œï¼‰
âœ… DAY14ï¼šLottieåŠ¨ç”»é›†æˆ
âœ… DAY15ï¼šPNGåŠ¨ç”»å®Œæˆ + æŠ€æœ¯å¯åŠ¨
âœ… DAY16ï¼šè™šæ‹Ÿè€å¸ˆMR + ComfyUI
âœ… DAY17ï¼šæ‰«ç åŠŸèƒ½ + æ•´ä½“è”è°ƒ â† ä»Šå¤©

ğŸ”² DAY18+ï¼šä¼˜åŒ–è¿­ä»£ / çœŸæœºæµ‹è¯• / ä¸Šçº¿å‡†å¤‡
```

---

## ä»Šæ—¥æˆæœæ€»ç»“

âœ… æ‰«ç åŠŸèƒ½å®Œæ•´å®ç°ï¼ˆhtml5-qrcodeï¼‰
âœ… æ‰«ç â†’è§£é”â†’å¼¹çª—å®Œæ•´æµç¨‹è·‘é€š
âœ… å­¦ä¹ æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
âœ… ä¿®å¤3ä¸ªå…³é”®Bugï¼ˆæ‘„åƒå¤´é‡Šæ”¾ã€é‡å¤æ‰«ç ã€MediaPipeé”€æ¯ï¼‰
âœ… è¾¹ç•Œæƒ…å†µå¤„ç†å®Œå–„

**æ ¸å¿ƒé‡Œç¨‹ç¢‘ï¼š** ä¸»æµç¨‹å…¨éƒ¨è·‘é€šï¼ä»å­¦ä¹ åˆ°è§£é”çš„é—­ç¯å®Œæˆï¼ğŸ‰

---

**é¡¹ç›®è¿›åº¦ï¼š** â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 70%ï¼ˆæ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œè¿›å…¥ä¼˜åŒ–é˜¶æ®µï¼‰
