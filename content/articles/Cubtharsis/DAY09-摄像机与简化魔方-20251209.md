# DAY09 - 2025.12.09 (周一)

## 完成内容

### 摄像机四档缩放系统

重构 `IsometricCamera.cs`，实现四档缩放切换：

- **第一档 Close**：OrthoSize 6，近距离跟随主角
- **第二档 Normal**：OrthoSize 12，常规解谜视角
- **第三档 Overview**：OrthoSize 可配置，全场景预览（可设置独立中心点）
- **第四档 Puzzle**：OrthoSize 可配置，魔方解谜视角（跟随魔方中心）

功能特点：
- 滚轮切换档位（带 0.3s 冷却防连续触发）
- 中心点和 OrthoSize 同步平滑过渡（统一使用 SmoothDamp 算法）
- 魔方浮空时自动切换到 Puzzle 档位，落地时切回 Normal

---

### PuzzleCube 浮空动画优化

- 动画改用 `SmoothDamp`，和摄像机过渡算法一致，更丝滑
- 浮空时自动设置摄像机 `puzzleCenter` 并切换到 Puzzle 档位
- 落地时自动切回 Normal 档位

---

### 平台跟随系统重构

解决玩家在移动平台上的各种问题：

**电梯平台（Tag="Elevator"）**：
- 使用父子关系跟随，最稳定无抖动

**普通平台**：
- 使用手动位置跟随，避免缩放继承问题
- 记录平台位置/旋转，每帧计算增量并应用

---

### 悬崖检测优化

- 射线检测距离从 3m 改为 5m
- 高度差限制放宽：上坡 2.5m，下坡 2m
- 支持更高的台阶和更陡的坡道

---

### 调试功能

- **Shift + 右键**：瞬移到点击位置，方便调试

---

### SimpleCubeRotator 简化魔方系统

创建 `Scripts/Puzzle/SimpleCubeRotator.cs`，支持任意形状的"魔方"（十字形、L形等）：

核心功能：
- 拖拽方块表面 → 旋转对应层（U/D/R/L/F/B + 中间层 E/M/S）
- 支持手动设置中心点（`centerCube` 或 `centerOffset`）
- 自动计算中心点（所有方块平均位置）

激活选择机制：
- 右键点击魔方 → 激活该魔方（高亮显示）
- 右键点击其他地方 → 取消激活
- 全局只有一个魔方可被激活

运行时可视化：
- 3x3x3 网格线框显示
- 灰色(默认) / 浅绿(激活) / 黄色(玩家站立禁止)

---

### 点击/拖拽区分

重构 `PlayerController.cs`：
- 按下时间 < 0.2s 且移动距离 < 30px → 点击移动
- 否则 → 拖拽（由魔方脚本处理）

---

## 当前脚本结构

```
Scripts/
├── Core/
│   ├── GameManager.cs
│   ├── WhiteboxSceneSetup.cs
│   └── WhiteboxUI.cs
├── Player/
│   ├── PlayerController.cs   # 点击移动 + 平台跟随 + 调试瞬移
│   └── IsometricCamera.cs    # 四档缩放
├── Puzzle/
│   ├── PuzzleCube.cs         # 浮空魔方（SmoothDamp动画）
│   ├── SimpleCubeRotator.cs  # 简化魔方旋转
│   └── TriggerMovePlatform.cs
├── Labyrinth/
│   ├── GeneratedCubeRotator.cs
│   ├── LabyrinthCubeController.cs
│   └── CubeDragRotator.cs
└── ...
```

---

## 下一步

- [ ] 解决玩家在魔方旋转轨迹上行走的问题（Layer 方案）
- [ ] 魔方纹路系统
- [ ] 简单谜题原型

---

## Memory

- [x] SimpleCubeRotator 需要 PlayerController.Instance → 添加单例属性
- [x] 玩家在方块边缘移不动（障碍物误判）→ 提高检测高度1.2f，收紧墙壁判断dotUp<0.1
- [x] 触发器挡住玩家移动 → 射线检测添加 QueryTriggerInteraction.Ignore
- [x] 玩家站在魔方上仍可旋转 → 射线加长到2f，忽略触发器
- [x] 线框颜色状态区分 → 灰色(默认)、浅绿(激活)、黄色(玩家站立禁止)
- [x] 横向旋转方向反了 → U/D/E层方向判断取反
- [x] 直线移动无法绕路 → 添加 FindWalkableDirection() 尝试左右30°/60°/90°绕行
- [x] 玩家悬空问题 → 改用 CharacterController + 强制贴地 + 设为地面子物体
- [x] 平台移动时玩家弹跳 → 删除 Rigidbody，只保留 CharacterController
- [x] 悬崖检测太严格走不上台阶 → 放宽高度差判断到±2.5米
- [x] orthoSize小时点击远处无法移动 → 射线检测距离从100f改为500f
- [x] 缩放平台导致玩家缩放 → 普通平台用手动位置跟随，不用父子关系
- [x] 升降电梯抖动 → Tag="Elevator"的平台用父子关系，其他用手动跟随
- [x] 魔方浮空动画和摄像机不同步 → 改用SmoothDamp，和摄像机一致
- [x] 摄像机加第四档Puzzle → 魔方浮空时自动切换，可配置puzzleOrthoSize和puzzleCenterOffset
