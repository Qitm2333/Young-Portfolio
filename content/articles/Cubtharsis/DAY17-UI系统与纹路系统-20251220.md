# DAY17 - 2025.12.20 (周六)

## 今日完成

### 打包与发布准备
- [x] 首次 Windows Build 成功
- [x] 修复 ProceduralVine.cs 编辑器 API 打包错误（#if UNITY_EDITOR）
- [x] 修复 Shader.Find 打包问题（CircleMask、CircleRipple、线框 Shader）
- [x] 为动态创建材质的脚本添加 Shader 引用字段
- [x] IntroSequence 添加黑屏等待（loadingWaitTime）解决首帧白屏

### 音频系统升级
- [x] 双轨道 BGM 系统（主 BGM + 雨天叠加层）
- [x] 雨天时雨天层淡入，晴天时淡出
- [x] Ending 模式：双轨道停止，只播放结局 BGM
- [x] 独立的雨天层淡入淡出速度（rainLayerFadeSpeed）
- [x] BGM 交叉淡入淡出速度优化

### UI 提示系统
- [x] ScrollHintUI 简化重构，基于入场时间计算显示
- [x] HintUI 通用提示脚本，支持多种显示/消失条件
- [x] ClickRipple 点击涟漪反馈（圆环扩散淡出 Shader）
- [x] CircleMask Shader 修复 _MainTex 属性缺失

### HintUI 功能
显示条件：
- AfterIntro - 入场结束后
- AfterHint - 另一个 HintUI 消失后
- AfterCollect - 收集物被收集后
- OnTriggerEnter - 玩家进入触发区域

消失条件：
- Scroll / LeftClick / RightClick / AnyClick
- PressQ / PressSpace

### 结局过场系统
- [x] ClickToMove 点击门触发玩家移动到指定位置
- [x] 屏幕坐标检测（不依赖射线击中）
- [x] 触发后禁用玩家输入、强制晴天、切换摄像机档位
- [x] IsometricCamera 第五档 Ending（结局过场视角）

### 输入控制优化
- [x] IntroSequence 入场期间禁用滚轮缩放
- [x] TriggerMovePlatform 移动期间禁用玩家输入
- [x] IsometricCamera.enableZoomInput 开关

### 暂停菜单系统
- [x] PauseMenuUI 暂停按钮延迟显示（3秒后淡入）
- [x] 移除 Time.timeScale 暂停（避免 NaN 错误）
- [x] 改用禁用 PlayerController 实现暂停
- [x] 禁用 Button 颜色过渡避免闪烁

### 纹路系统
- [x] 临时材质处理

---

## 新增/修改脚本

| 脚本 | 路径 | 功能 |
|------|------|------|
| HintUI | Scripts/UI/ | 通用提示 UI，可配置显示/消失条件 |
| ClickRipple | Scripts/UI/ | 点击涟漪反馈，添加 Shader 引用字段 |
| CircleMaskUI | Scripts/UI/ | 圆形遮罩，添加 Shader 引用字段 |
| SimpleCubeRotator | Scripts/Puzzle/ | 线框显示，添加 Shader 引用字段 |
| ClickToMove | Scripts/Puzzle/ | 点击物件触发玩家移动 |
| AudioManager | Scripts/Audio/ | 双轨道 BGM + 雨天层 + Ending 模式 |
| IntroSequence | Scripts/Core/ | 添加黑屏等待时间 |
| ProceduralVine | Scripts/Environment/ | 修复编辑器 API 打包错误 |
| CircleRipple.shader | Shader/UI/ | 圆环涟漪效果 |

---

## 打包注意事项

- Shader.Find() 在打包后可能找不到未被直接引用的 Shader
- 解决方案：为脚本添加 public Shader 字段，在 Inspector 中拖入
- 或将 Shader 加入 Project Settings → Graphics → Always Included Shaders
- 编辑器专用 API（如 EditorApplication）需用 #if UNITY_EDITOR 包裹

---

## 已知问题

- Restart 后 NULL 物体消失（WindowsBLE 的 DontDestroyOnLoad 导致）
- 解决方案：将 WindowsBLE 移到单独物体，NULL 只作为位置标记

---

## 明日计划

- [ ] 上传到 itch.io
- [ ] 准备封面图和截图
- [ ] 编写游戏描述

---

## Memory

- HintUI 通用化 → 一个脚本支持多种触发条件，避免重复代码
- 屏幕坐标检测 → 不需要物体有 Collider，用 WorldToScreenPoint 计算距离
- 入场禁用输入 → PlayerController.enabled + IsometricCamera.enableZoomInput
- 结局过场 → 禁用输入 + 强制晴天 + 摄像机 Ending 档位
- 暂停不用 Time.timeScale → 避免动画/物理计算 NaN 错误
- DontDestroyOnLoad 陷阱 → 会导致场景重载时新物体被销毁
- Shader.Find 打包陷阱 → 动态创建材质时 Shader 可能不被包含
- 双轨道 BGM → 主 BGM 始终播放，雨天层根据天气淡入淡出
