# DAY15 - 2025.12.18 (周四)

## 今日任务

### 场景优化
- [x] 云朵系统
- [x] 情绪转化系统
- [x] 屏幕空间光晕天气联动
- [x] 云朵位移功能
- [x] 天气粒子系统
- [x] 后处理调色联动

---

## 完成内容

### 云朵系统

**CloudRotator** `Assets/Scripts/Environment/CloudRotator.cs`：
- 绕指定中心点旋转（留空则绕世界原点）
- 新增位移功能：设置方向和速度，云朵直线移动
- 编辑器实时预览
- 支持捕获初始位置，游戏开始自动重置

### 情绪转化系统

**EmotionAbility** `Assets/Scripts/Emotion/EmotionAbility.cs`：

材质对系统：
- 晴天/雨天材质配对，自动查找 Renderer
- MaterialPropertyBlock 不修改原材质

后处理联动（天气切换平滑过渡）：
- Vignette：晴天 0 → 雨天 0.25
- FilmGrain ShadowThreshold：晴天 0.47 → 雨天 0.1
- Bloom Threshold：晴天 0.9 → 雨天 0.75
- PostExposure：晴天 -0.1 → 雨天 0
- Contrast：晴天 -4 → 雨天 -10
- Saturation：晴天 20 → 雨天 22
- 灯光颜色：暖白 → 蓝色

### 屏幕空间光晕系统

**LensGlowRenderFeature** `Assets/Scripts/PostProcess/LensGlowRenderFeature.cs`：
- URP Render Feature，后处理阶段绘制光晕
- 支持多光源（最多 16 个）
- 全局透明度控制（GlobalAlpha）

**LensGlowSource** `Assets/Scripts/Environment/LensGlowSource.cs`：
- 挂在灯光物体上，自动注册
- Size 范围扩展到 0.01-5

**LensGlowWeatherLink** `Assets/Scripts/Environment/LensGlowWeatherLink.cs`：
- 监听天气状态，控制光晕透明度
- 晴天隐藏（0），雨天显示（1）
- 平滑过渡

### 天气粒子系统

**WeatherParticle** `Assets/Scripts/Environment/WeatherParticle.cs`：
- 监听 EmotionAbility 事件
- 雨天播放粒子，晴天停止
- 支持反向设置（晴天播放）

### 问题修复

- 粒子 Culling Mode 问题：`Pause and Catch-up` 导致运行时粒子不显示，改为 `Always Simulate`
- 旧版粒子 Shader（Mobile/Particles/Additive）在 URP 运行时不渲染大面片

---

## Memory

- [x] 云朵旋转 → RotateAround(center, axis, speed * deltaTime)
- [x] 云朵位移 → position += direction.normalized * speed * deltaTime
- [x] 材质切换不修改原文件 → MaterialPropertyBlock
- [x] Volume 后处理控制 → profile.TryGet<T>() + parameter.value
- [x] 屏幕空间光晕 → WorldToViewportPoint + 全屏三角形
- [x] 光晕天气联动 → 静态 GlobalAlpha + 独立脚本监听事件
- [x] 粒子天气联动 → 监听 OnRainStart/OnRainEnd 事件
- [x] 粒子运行时不显示 → 检查 Culling Mode，改为 Always Simulate
- [x] 旧版粒子 Shader 问题 → 换 URP Particles Shader 或检查 Culling

---

## 下一步

- [ ] 魔方纹路系统（拱门前魔方贴图和模型）
- [ ] 第二场景制作
- [ ] 角色动画与交互
